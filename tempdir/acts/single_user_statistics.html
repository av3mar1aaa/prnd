{% extends "base.html" %}

{% block title %}Отчет пользователя {{ realname }} ({{ nickname }}) за {{ year }}-й год{% endblock %}

{% block content %}
{% if not is_laboratory and not is_institute %}

<h4 class="mb-4">Отчет пользователя {{ realname }} (<a href="{{ user_profile_path }}">{{ nickname }}</a>) за {{ year }}-й год</h4>

{% if typed_act_list %}
  {% for type in typed_act_list %}
    {% if type.full_info_act_list or not wbreport %}
    <div class="card mb-3">
      <div class="card-header">
        <h5 class="card-title mb-0">{{ type.act_type_name1 }}</h5>
      </div>
      <div class="table-responsive">
        <table class="table table-vcenter card-table {% if wbreport %}table-bordered{% endif %}">
          <thead>
            <tr>
              {% if not wbreport %}<th class="w-1">ссылка</th>{% endif %}
              <th>{{ type.act_type_name1 }}</th>
              <th class="w-1 text-center">балл</th>
            </tr>
          </thead>
          <tbody>
            {% if type.full_info_act_list %}
              {% for act in type.full_info_act_list %}
              <tr>
                {% if not wbreport %}<td class="text-center"><a href="/prnd/{{ act.act_path }}">{{ forloop.counter }}</a></td>{% endif %}
                <td>{{ act.html_str|safe }}</td>
                <td class="text-center">{{ act.cost }}</td>
              </tr>
              {% endfor %}
              <tr class="table-active">
                {% if not wbreport %}<td></td>{% endif %}
                <td class="text-end fw-bold">Итого:</td>
                <td class="text-center fw-bold">{{ type.total }}</td>
              </tr>
            {% else %}
              <tr>
                {% if not wbreport %}<td></td>{% endif %}
                <td class="text-center text-muted">Нет записей.</td>
                <td></td>
              </tr>
            {% endif %}
            {% if not wbreport %}
            <tr>
              <td></td>
              <td class="text-center"><a href="{{ type.add_path }}" class="btn btn-sm btn-outline-primary"><i class="ti ti-plus"></i> добавить запись</a></td>
              <td></td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}
  {% endfor %}
{% endif %}

<div class="card mb-4">
  <div class="table-responsive">
    <table class="table table-vcenter card-table {% if wbreport %}table-bordered{% endif %}">
      <thead>
        <tr>
          {% if not wbreport %}<th class="w-1"></th>{% endif %}
          <th>комментарий</th>
          <th class="w-1 text-center">всего</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          {% if not wbreport %}<td></td>{% endif %}
          <td class="text-muted small">Пожалуйста, имейте в виду то, что окончательный балл устанавливается на заседании ученого совета.</td>
          <td class="text-center fw-bold">{{ full_cost }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<form action="." method="post">
  {% csrf_token %}

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="card-title mb-0">Развернутый отчет</h5>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label text-muted small">Развернутый отчет о полученных результатах. Используйте тэг &lt;p&gt; для нового абзаца.</label>
        {% if can_modify_detailed_report %}
          {{ form.detailed_report }}
          {% if form.detailed_report.errors %}<div class="text-danger small mt-1">{{ form.detailed_report.html_error_list }}</div>{% endif %}
        {% else %}
          <div class="form-control-plaintext">{{ detailed_report|safe }}</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="card-title mb-0">Статус отчета</h5>
    </div>
    <div class="table-responsive">
      <table class="table table-vcenter card-table {% if wbreport %}table-bordered{% endif %}">
        <tbody>
          {% if can_see_group_average %}
          <tr>
            <td class="w-25">средний балл по лаборатории</td>
            <td>{{ group_average }} {{ group_average_explanation }}</td>
            <td class="w-1"></td>
          </tr>
          {% endif %}
          <tr>
            <td>кол-во баллов</td>
            <td>{{ calculated_cost }}</td>
            <td></td>
          </tr>
          {% if can_see_calc_as_maximum_flag %}
          <tr>
            <td>начисление баллов</td>
            {% if can_modify_calc_as_maximum_flag %}
            <td>
              {{ form.calcasmaximum }}
              <span class="text-muted small">(как максимум из индивидуального ПРНД и суммы 75% среднего ПРНД сотрудников подразделения и 50% индивидуального ПРНД)</span>
            </td>
            <td>{% if form.calcasmaximum.errors %}<div class="text-danger small">{{ form.calcasmaximum.html_error_list }}</div>{% endif %}</td>
            {% else %}
            <td>{{ calcasmaximum }}</td>
            <td></td>
            {% endif %}
          </tr>
          {% endif %}
          <tr>
            <td>исходный коэффициент</td>
            <td>{{ def_coef }} = {{ def_reason }}</td>
            <td></td>
          </tr>
          <tr>
            <td>статус</td>
            {% if can_modify_status %}
            <td>{{ form.status }}</td>
            <td>{% if form.status.errors %}<div class="text-danger small">{{ form.status.html_error_list }}</div>{% endif %}</td>
            {% else %}
            <td>{{ status }}</td>
            <td></td>
            {% endif %}
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  {% if can_modify %}
  <div class="mb-4">
    <button type="submit" class="btn btn-primary"><i class="ti ti-device-floppy"></i> Сохранить</button>
  </div>
  {% endif %}
</form>

{% if not wbreport %}
<div class="mb-4">
  <a href="wb/" class="btn btn-outline-secondary btn-sm"><i class="ti ti-printer"></i> версия для печати</a>
</div>
{% endif %}

{% else %}

{% if user_report_list %}
<h4 class="mb-4">
  {% if is_laboratory %}Отчеты сотрудников лаборатории{% endif %}
  {% if is_institute %}Отчеты лабораторий{% endif %}
  за {{ year }}-й год
</h4>

<div class="table-responsive mb-4">
  <table class="table table-vcenter card-table">
    <thead>
      <tr>
        <th>сотрудник</th>
        <th>отчет</th>
      </tr>
    </thead>
    <tbody>
      {% for rep in user_report_list %}
      <tr>
        <td>{{ rep.name }}</td>
        <td>{{ rep.detailed_report|safe }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

{% if is_institute %}
<h4 class="mb-3">Научная деятельность лабораторий за {{ year }}-й год</h4>
<div class="list-group mb-4">
  <a href="/prnd/all/publications/{{ year }}/" class="list-group-item list-group-item-action d-flex align-items-center gap-2"><i class="ti ti-article text-muted"></i> публикации</a>
  <a href="/prnd/all/monographs/{{ year }}/" class="list-group-item list-group-item-action d-flex align-items-center gap-2"><i class="ti ti-book text-muted"></i> монографии</a>
  <a href="/prnd/all/conferences/{{ year }}/" class="list-group-item list-group-item-action d-flex align-items-center gap-2"><i class="ti ti-presentation text-muted"></i> доклады</a>
  <a href="/prnd/all/courses/{{ year }}/" class="list-group-item list-group-item-action d-flex align-items-center gap-2"><i class="ti ti-school text-muted"></i> курсы лекций и семинары</a>
  <a href="/prnd/all/patents/{{ year }}/" class="list-group-item list-group-item-action d-flex align-items-center gap-2"><i class="ti ti-license text-muted"></i> патенты</a>
  <a href="/prnd/all/supervising/{{ year }}/" class="list-group-item list-group-item-action d-flex align-items-center gap-2"><i class="ti ti-users-group text-muted"></i> научное руководство</a>
  <a href="/prnd/all/editing/{{ year }}/" class="list-group-item list-group-item-action d-flex align-items-center gap-2"><i class="ti ti-edit text-muted"></i> редактирование научных изданий</a>
  <a href="/prnd/all/editingcollegium/{{ year }}/" class="list-group-item list-group-item-action d-flex align-items-center gap-2"><i class="ti ti-clipboard-text text-muted"></i> работа в составе ред. коллегий</a>
  <a href="/prnd/all/orgwork/{{ year }}/" class="list-group-item list-group-item-action d-flex align-items-center gap-2"><i class="ti ti-building text-muted"></i> научно-орг. работа</a>
  <a href="/prnd/all/opposing/{{ year }}/" class="list-group-item list-group-item-action d-flex align-items-center gap-2"><i class="ti ti-scale text-muted"></i> оппонирование</a>
  <a href="/prnd/all/awards/{{ year }}/" class="list-group-item list-group-item-action d-flex align-items-center gap-2"><i class="ti ti-award text-muted"></i> награды</a>
</div>
{% endif %}

{% if is_laboratory %}
<div class="card mb-4">
  <div class="card-body text-center">
    <a href="/prnd/laboratory/{{ owner_id }}/{{ year }}/" class="btn btn-outline-primary">Все записи лаборатории за {{ year }}-й год</a>
  </div>
</div>
{% endif %}

{% if lab_list and is_institute %}
  {% for act in lab_list %}
  <div class="card mb-3">
    <div class="card-header">
      <h5 class="card-title mb-0">{{ act.act_name }}</h5>
    </div>
    <div class="table-responsive">
      <table class="table table-vcenter card-table">
        <tbody>
          {% for lab in act.act_lab_list %}
          <tr>
            <td class="w-25">{{ lab.name }}</td>
            <td>
              <ol class="mb-0">
                {% for pub in lab.list %}
                <li>{{ pub }}</li>
                {% endfor %}
              </ol>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endfor %}
{% endif %}

<div class="card mb-4">
  <div class="card-header">
    <h5 class="card-title mb-0">Отчет</h5>
  </div>
  <div class="card-body">
    <form action="." method="post">
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label text-muted small">Отчет. Используйте тэг &lt;p&gt; для нового абзаца.</label>
        {% if can_modify_detailed_report %}
          {{ form.detailed_report }}
          {% if form.detailed_report.errors %}<div class="text-danger small mt-1">{{ form.detailed_report.html_error_list }}</div>{% endif %}
        {% else %}
          <div class="form-control-plaintext">{{ detailed_report|safe }}</div>
        {% endif %}
      </div>
      {% if can_modify %}
      <button type="submit" class="btn btn-primary"><i class="ti ti-device-floppy"></i> Сохранить</button>
      {% endif %}
    </form>
  </div>
</div>

{% endif %}
{% endblock %}
